{"version":3,"sources":["../../../server/mongo_api/services/mongooseAutoIncrement.js"],"names":["mongoose","require","extend","counterSchema","IdentityCounter","exports","initialize","connection","model","ex","name","Schema","type","String","field","count","Number","plugin","schema","options","Error","settings","startAt","incrementBy","unique","fields","ready","add","findOne","err","counter","save","nextCount","callback","method","resetCount","findOneAndUpdate","pre","next","doc","isNew","$lt","$inc","updatedIdentityCounter","setTimeout"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","sourcesContent":["// Module Scope\nvar mongoose = require('mongoose'),\n  extend = require('extend'),\n  counterSchema,\n  IdentityCounter;\n/****************************************************************/\n/******* @author saladin jake (Victor juwa) ********************************/\n/******* @desc Express js || ****************/\n// Initialize plugin by creating counter collection in database.\nexports.initialize = function(connection) {\n  try {\n    IdentityCounter = connection.model('IdentityCounter');\n  } catch (ex) {\n    if (ex.name === 'MissingSchemaError') {\n      // Create new counter schema.\n      counterSchema = new mongoose.Schema({\n        model: { type: String, require: true },\n        field: { type: String, require: true },\n        count: { type: Number, default: 0 },\n      });\n\n      // Create a unique index using the \"field\" and \"model\" fields.\n      //counterSchema.index({ field: 1, model: 1 }, { unique: true, required: true, index: -1 });\n\n      // Create model using new schema.\n      IdentityCounter = connection.model('IdentityCounter', counterSchema);\n    } else throw ex;\n  }\n};\n\n// The function to use when invoking the plugin on a custom schema.\nexports.plugin = function(schema, options) {\n  // If we don't have reference to the counterSchema or the IdentityCounter model then the plugin was most likely not\n  // initialized properly so throw an error.\n  if (!counterSchema || !IdentityCounter)\n    throw new Error('mongoose-auto-increment has not been initialized');\n\n  // Default settings and plugin scope variables.\n  var settings = {\n      model: null, // The model to configure the plugin for.\n      field: '_id', // The field the plugin should track.\n      startAt: 0, // The number the count should start at.\n      incrementBy: 1, // The number by which to increment the count each time.\n      unique: true, // Should we create a unique index for the field\n    },\n    fields = {}, // A hash of fields to add properties to in Mongoose.\n    ready = false; // True if the counter collection has been updated and the document is ready to be saved.\n\n  switch (typeof options) {\n    // If string, the user chose to pass in just the model name.\n    case 'string':\n      settings.model = options;\n      break;\n    // If object, the user passed in a hash of options.\n    case 'object':\n      extend(settings, options);\n      break;\n  }\n\n  if (settings.model == null) throw new Error('model must be set');\n\n  // Add properties for field in schema.\n  fields[settings.field] = {\n    type: Number,\n    require: true,\n  };\n  if (settings.field !== '_id') fields[settings.field].unique = settings.unique;\n  schema.add(fields);\n\n  // Find the counter for this model and the relevant field.\n  IdentityCounter.findOne({ model: settings.model, field: settings.field }, function(err, counter) {\n    if (!counter) {\n      // If no counter exists then create one and save it.\n      counter = new IdentityCounter({\n        model: settings.model,\n        field: settings.field,\n        count: settings.startAt - settings.incrementBy,\n      });\n      counter.save(function() {\n        ready = true;\n      });\n    } else {\n      ready = true;\n    }\n  });\n\n  // Declare a function to get the next counter for the model/schema.\n  var nextCount = function(callback) {\n    IdentityCounter.findOne(\n      {\n        model: settings.model,\n        field: settings.field,\n      },\n      function(err, counter) {\n        if (err) return callback(err);\n        callback(null, counter === null ? settings.startAt : counter.count + settings.incrementBy);\n      },\n    );\n  };\n  // Add nextCount as both a method on documents and a static on the schema for convenience.\n  schema.method('nextCount', nextCount);\n  schema.static('nextCount', nextCount);\n\n  // Declare a function to reset counter at the start value - increment value.\n  var resetCount = function(callback) {\n    IdentityCounter.findOneAndUpdate(\n      { model: settings.model, field: settings.field },\n      { count: settings.startAt - settings.incrementBy },\n      { new: true }, // new: true specifies that the callback should get the updated counter.\n      function(err) {\n        if (err) return callback(err);\n        callback(null, settings.startAt);\n      },\n    );\n  };\n  // Add resetCount as both a method on documents and a static on the schema for convenience.\n  schema.method('resetCount', resetCount);\n  schema.static('resetCount', resetCount);\n\n  // Every time documents in this schema are saved, run this logic.\n  schema.pre('save', function(next) {\n    // Get reference to the document being saved.\n    var doc = this;\n\n    // Only do this if it is a new document (see http://mongoosejs.com/docs/api.html#document_Document-isNew)\n    if (doc.isNew) {\n      // Declare self-invoking save function.\n      (function save() {\n        // If ready, run increment logic.\n        // Note: ready is true when an existing counter collection is found or after it is created for the\n        // first time.\n        if (ready) {\n          // check that a number has already been provided, and update the counter to that number if it is\n          // greater than the current count\n          if (typeof doc[settings.field] === 'number') {\n            IdentityCounter.findOneAndUpdate(\n              // IdentityCounter documents are identified by the model and field that the plugin was invoked for.\n              // Check also that count is less than field value.\n              { model: settings.model, field: settings.field, count: { $lt: doc[settings.field] } },\n              // Change the count of the value found to the new field value.\n              { count: doc[settings.field] },\n              function(err) {\n                if (err) return next(err);\n                // Continue with default document save functionality.\n                next();\n              },\n            );\n          } else {\n            // Find the counter collection entry for this model and field and update it.\n            IdentityCounter.findOneAndUpdate(\n              // IdentityCounter documents are identified by the model and field that the plugin was invoked for.\n              { model: settings.model, field: settings.field },\n              // Increment the count by `incrementBy`.\n              { $inc: { count: settings.incrementBy } },\n              // new:true specifies that the callback should get the counter AFTER it is updated (incremented).\n              { new: true },\n              // Receive the updated counter.\n              function(err, updatedIdentityCounter) {\n                if (err) return next(err);\n                // If there are no errors then go ahead and set the document's field to the current count.\n                doc[settings.field] = updatedIdentityCounter.count;\n                // Continue with default document save functionality.\n                next();\n              },\n            );\n          }\n        }\n        // If not ready then set a 5 millisecond timer and try to save again. It will keep doing this until\n        // the counter collection is ready.\n        else setTimeout(save, 5);\n      })();\n    }\n    // If the document does not have the field we're interested in or that field isn't a number AND the user did\n    // not specify that we should increment on updates, then just continue the save without any increment logic.\n    else next();\n  });\n};\n"],"file":"mongooseAutoIncrement.js"}