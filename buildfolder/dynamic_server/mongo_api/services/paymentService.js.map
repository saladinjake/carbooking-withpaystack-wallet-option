{"version":3,"sources":["../../../../server/dynamic_server/mongo_api/services/paymentService.js"],"names":["uuidv4","require","crypto","moment","GatewayTransaction","APIError","httpStatus","Customer","Transaction","simulateGatewayCall","card","amount","status","hex","randomBytes","Math","ceil","toString","slice","auth_code","parseInt","transactionId","paymentDate","authorizationCode","exports","debitCard","accountNumber","gatewayResponse","gatewayTransaction","save","savedGatewayTransaction","message","PAYMENT_REQUIRED","transaction","operation","reference","savedTransaction","findOne","savedCustomer","response","transform","customer","transformBalance"],"mappings":"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","sourcesContent":["const uuidv4 = require('uuid/v4');\nconst crypto = require('crypto');\nconst moment = require('moment-timezone');\nconst GatewayTransaction = require('../models/gatewayTransaction.model');\nconst APIError = require('../utils/APIError');\nconst httpStatus = require('http-status');\nconst Customer = require('../models/User.model');\nconst Transaction = require('../models/transaction.model');\n/****************************************************************/\n/******* @author saladin jake (Victor juwa) ********************************/\n/******* @desc Express js || ****************/\nasync function simulateGatewayCall(card, amount) {\n  let status = 'success';\n  if (card === '4242424242424242') {\n    status = 'failure';\n  }\n\n  const hex = crypto\n    .randomBytes(Math.ceil(6 / 2))\n    .toString('hex')\n    .slice(0, 6);\n  const auth_code = parseInt(hex, 16);\n\n  return {\n    transactionId: uuidv4(),\n    status: status,\n    paymentDate: moment(),\n    amount: amount,\n    authorizationCode: auth_code,\n  };\n}\n\nexports.debitCard = async (accountNumber, card, amount) => {\n  const gatewayResponse = await simulateGatewayCall(card, amount);\n  const gatewayTransaction = new GatewayTransaction(gatewayResponse);\n  const savedGatewayTransaction = await gatewayTransaction.save();\n  if (savedGatewayTransaction.status === 'failure') {\n    throw new APIError({\n      message: 'Payment Rejected',\n      status: httpStatus.PAYMENT_REQUIRED,\n    });\n  }\n\n  const transaction = new Transaction();\n  transaction.amount = amount;\n  transaction.operation = 'deposit';\n  transaction.accountNumber = accountNumber;\n  transaction.reference = 'payment_gateway_transaction:' + savedGatewayTransaction.transactionId;\n  const savedTransaction = await transaction.save();\n  const savedCustomer = await Customer.findOne({ accountNumber: accountNumber });\n  const response = {\n    transaction: transaction.transform(),\n    customer: savedCustomer.transformBalance(),\n  };\n  return response;\n};\n"],"file":"paymentService.js"}