{"version":3,"sources":["../../../../server/dynamic_server/mongo_api/services/MailMan.js"],"names":["Q","require","nodemailer","emailTemplates","sendMailTransport","module","exports","_template","_transport","init","config","d","defer","emailTplsDir","err","template","reject","createTransport","service","auth","user","process","env","SENDGRID_USERNAME","pass","SENDGRID_PASSWORD","resolve","bind","promise","send","from","to","subject","text","html","params","sendMail","res","console","error","tplName","locals","self","then"],"mappings":"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","sourcesContent":["var Q = require('q'); \r\nvar nodemailer = require('nodemailer');\r\nvar emailTemplates = require('email-templates');\r\nvar sendMailTransport = require('nodemailer-smtp-transport');\r\n\r\nmodule.exports = {\r\n  _template: null, \r\n  _transport: null,\r\n\r\n  init: function (config) {\r\n    var d = Q.defer();\r\n\r\n    emailTemplates(config.emailTplsDir, function (err, template) {\r\n      if (err) {\r\n        return d.reject(err);\r\n      }\r\n\r\n      this._template = template;\r\n      this._transport = nodemailer.createTransport({ service: 'Sendgrid', auth: { user: process.env.SENDGRID_USERNAME, pass: process.env.SENDGRID_PASSWORD } });\r\n      return d.resolve();\r\n    }.bind(this));\r\n\r\n    return d.promise;\r\n  },\r\n\r\n  send: function (from, to, subject, text, html) {\r\n    var d = Q.defer();\r\n    var params = {\r\n      from: from, \r\n      to: to,\r\n      subject: subject,\r\n      text: text\r\n    };\r\n\r\n    if (html) {\r\n      params.html = html;\r\n    }\r\n\r\n    this._transport.sendMail(params, function (err, res) {\r\n      if (err) {\r\n        console.error(err);\r\n        return d.reject(err);\r\n      } else {\r\n        return d.resolve(res);\r\n      }\r\n    });\r\n\r\n    return d.promise;\r\n  },\r\n\r\n  sendMail: function (from, to, subject, tplName, locals) {\r\n    var d = Q.defer();\r\n    var self = this;\r\n    this.init({ emailTplsDir: \"email-templates\" }).then(function () {\r\n      this._template(tplName, locals, function (err, html, text) {\r\n        if (err) {\r\n          console.error(err);\r\n          return d.reject(err);\r\n        }\r\n\r\n        self.send(from, to, subject, text, html)\r\n          .then(function (res) {\r\n            return d.resolve(res);\r\n          });\r\n      });\r\n    }.bind(this));\r\n\r\n    return d.promise;\r\n  }\r\n};"],"file":"MailMan.js"}