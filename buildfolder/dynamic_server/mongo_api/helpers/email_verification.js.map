{"version":3,"sources":["../../../../server/dynamic_server/mongo_api/helpers/email_verification.js"],"names":["module","exports","_template","_transport","init","config","d","Q","defer","emailTemplates","emailTplsDir","err","template","reject","nodemailer","createTransport","service","auth","user","process","env","SENDGRID_USERNAME","pass","SENDGRID_PASSWORD","resolve","bind","promise","send","from","to","subject","text","html","params","sendMail","res","console","error","tplName","locals","self","then"],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport nodemailer from 'nodemailer';\nimport smtpTransport from 'nodemailer-smtp-transport';\nimport config from '../config/mongo_config.js';\nimport handlebars from 'handlebars';\nimport Q from 'q';\n\n('use strict');\n\nmodule.exports = {\n  _template: null,\n  _transport: null,\n\n  init: function(config) {\n    var d = Q.defer();\n\n    emailTemplates(\n      config.emailTplsDir,\n      function(err, template) {\n        if (err) {\n          return d.reject(err);\n        }\n\n        this._template = template;\n        this._transport = nodemailer.createTransport({\n          service: 'Sendgrid',\n          auth: { user: process.env.SENDGRID_USERNAME, pass: process.env.SENDGRID_PASSWORD },\n        });\n        return d.resolve();\n      }.bind(this),\n    );\n\n    return d.promise;\n  },\n\n  send: function(from, to, subject, text, html) {\n    var d = Q.defer();\n    var params = {\n      from: from,\n      to: to,\n      subject: subject,\n      text: text,\n    };\n\n    if (html) {\n      params.html = html;\n    }\n\n    this._transport.sendMail(params, function(err, res) {\n      if (err) {\n        console.error(err);\n        return d.reject(err);\n      } else {\n        return d.resolve(res);\n      }\n    });\n\n    return d.promise;\n  },\n\n  sendMail: function(from, to, subject, tplName, locals) {\n    var d = Q.defer();\n    var self = this;\n    this.init({ emailTplsDir: 'email-templates' }).then(\n      function() {\n        this._template(tplName, locals, function(err, html, text) {\n          if (err) {\n            console.error(err);\n            return d.reject(err);\n          }\n\n          self.send(from, to, subject, text, html).then(function(res) {\n            return d.resolve(res);\n          });\n        });\n      }.bind(this),\n    );\n\n    return d.promise;\n  },\n};\n"],"file":"email_verification.js"}