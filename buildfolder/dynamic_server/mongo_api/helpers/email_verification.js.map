{"version":3,"sources":["../../../../server/dynamic_server/mongo_api/helpers/email_verification.js"],"names":["module","exports","_template","_transport","init","config","d","Q","defer","emailTemplates","emailTplsDir","err","template","reject","nodemailer","createTransport","service","auth","user","process","env","SENDGRID_USERNAME","pass","SENDGRID_PASSWORD","resolve","bind","promise","send","from","to","subject","text","html","params","sendMail","res","console","error","tplName","locals","self","then"],"mappings":"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","sourcesContent":["import fs from 'fs';\r\nimport nodemailer  from 'nodemailer';\r\nimport smtpTransport from 'nodemailer-smtp-transport';\r\nimport config from '../config/mongo_config.js';\r\nimport handlebars from 'handlebars';\r\nimport Q from 'q';\r\n\r\n'use strict';\r\n\r\nmodule.exports = {\r\n  _template: null, \r\n  _transport: null,\r\n \r\n  init: function (config) {\r\n    var d = Q.defer();\r\n \r\n    emailTemplates(config.emailTplsDir, function (err, template) {\r\n      if (err) {\r\n        return d.reject(err);\r\n      }\r\n \r\n      this._template = template;\r\n      this._transport = nodemailer.createTransport({ service: 'Sendgrid', auth: { user: process.env.SENDGRID_USERNAME, pass: process.env.SENDGRID_PASSWORD } });\r\n      return d.resolve();\r\n    }.bind(this));\r\n \r\n    return d.promise;\r\n  },\r\n \r\n  send: function (from, to, subject, text, html) {\r\n    var d = Q.defer();\r\n    var params = {\r\n      from: from, \r\n      to: to,\r\n      subject: subject,\r\n      text: text\r\n    };\r\n \r\n    if (html) {\r\n      params.html = html;\r\n    }\r\n \r\n    this._transport.sendMail(params, function (err, res) {\r\n      if (err) {\r\n        console.error(err);\r\n        return d.reject(err);\r\n      } else {\r\n        return d.resolve(res);\r\n      }\r\n    });\r\n \r\n    return d.promise;\r\n  },\r\n \r\n  sendMail: function (from, to, subject, tplName, locals) {\r\n    var d = Q.defer();\r\n    var self = this;\r\n    this.init({ emailTplsDir: \"email-templates\" }).then(function () {\r\n      this._template(tplName, locals, function (err, html, text) {\r\n        if (err) {\r\n          console.error(err);\r\n          return d.reject(err);\r\n        }\r\n \r\n        self.send(from, to, subject, text, html)\r\n          .then(function (res) {\r\n            return d.resolve(res);\r\n          });\r\n      });\r\n    }.bind(this));\r\n \r\n    return d.promise;\r\n  }\r\n};"],"file":"email_verification.js"}