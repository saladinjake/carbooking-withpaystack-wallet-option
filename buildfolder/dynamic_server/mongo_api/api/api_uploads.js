"use strict";

var cov_1gh6s2th7z = function () {
  var path = "C:\\Users\\Obiajulu\\Desktop\\commute\\commute-dev-Proj-repo\\server\\dynamic_server\\mongo_api\\api\\api_uploads.js";
  var hash = "a2ae6b4f1719cd047dc8ece164f69fb3b6500e69";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "C:\\Users\\Obiajulu\\Desktop\\commute\\commute-dev-Proj-repo\\server\\dynamic_server\\mongo_api\\api\\api_uploads.js",
    statementMap: {
      "0": {
        start: {
          line: 3,
          column: 12
        },
        end: {
          line: 3,
          column: 30
        }
      },
      "1": {
        start: {
          line: 5,
          column: 0
        },
        end: {
          line: 5,
          column: 16
        }
      },
      "2": {
        start: {
          line: 8,
          column: 19
        },
        end: {
          line: 8,
          column: 52
        }
      },
      "3": {
        start: {
          line: 18,
          column: 0
        },
        end: {
          line: 22,
          column: 3
        }
      },
      "4": {
        start: {
          line: 29,
          column: 18
        },
        end: {
          line: 29,
          column: 34
        }
      },
      "5": {
        start: {
          line: 33,
          column: 4
        },
        end: {
          line: 33,
          column: 25
        }
      },
      "6": {
        start: {
          line: 51,
          column: 4
        },
        end: {
          line: 77,
          column: 7
        }
      },
      "7": {
        start: {
          line: 52,
          column: 17
        },
        end: {
          line: 52,
          column: 29
        }
      },
      "8": {
        start: {
          line: 55,
          column: 23
        },
        end: {
          line: 55,
          column: 45
        }
      },
      "9": {
        start: {
          line: 56,
          column: 23
        },
        end: {
          line: 56,
          column: 45
        }
      },
      "10": {
        start: {
          line: 57,
          column: 23
        },
        end: {
          line: 63,
          column: 7
        }
      },
      "11": {
        start: {
          line: 65,
          column: 6
        },
        end: {
          line: 76,
          column: 9
        }
      },
      "12": {
        start: {
          line: 66,
          column: 8
        },
        end: {
          line: 69,
          column: 9
        }
      },
      "13": {
        start: {
          line: 67,
          column: 10
        },
        end: {
          line: 67,
          column: 27
        }
      },
      "14": {
        start: {
          line: 68,
          column: 10
        },
        end: {
          line: 68,
          column: 27
        }
      },
      "15": {
        start: {
          line: 70,
          column: 27
        },
        end: {
          line: 73,
          column: 9
        }
      },
      "16": {
        start: {
          line: 74,
          column: 8
        },
        end: {
          line: 74,
          column: 46
        }
      },
      "17": {
        start: {
          line: 75,
          column: 8
        },
        end: {
          line: 75,
          column: 18
        }
      },
      "18": {
        start: {
          line: 86,
          column: 4
        },
        end: {
          line: 88,
          column: 7
        }
      },
      "19": {
        start: {
          line: 95,
          column: 2
        },
        end: {
          line: 99,
          column: 5
        }
      },
      "20": {
        start: {
          line: 96,
          column: 5
        },
        end: {
          line: 96,
          column: 32
        }
      },
      "21": {
        start: {
          line: 97,
          column: 5
        },
        end: {
          line: 97,
          column: 31
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 32,
            column: 2
          },
          end: {
            line: 32,
            column: 3
          }
        },
        loc: {
          start: {
            line: 32,
            column: 22
          },
          end: {
            line: 34,
            column: 3
          }
        },
        line: 32
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 35,
            column: 2
          },
          end: {
            line: 35,
            column: 3
          }
        },
        loc: {
          start: {
            line: 35,
            column: 17
          },
          end: {
            line: 101,
            column: 3
          }
        },
        line: 35
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 51,
            column: 32
          },
          end: {
            line: 51,
            column: 33
          }
        },
        loc: {
          start: {
            line: 51,
            column: 46
          },
          end: {
            line: 77,
            column: 5
          }
        },
        line: 51
      },
      "3": {
        name: "(anonymous_3)",
        decl: {
          start: {
            line: 65,
            column: 45
          },
          end: {
            line: 65,
            column: 46
          }
        },
        loc: {
          start: {
            line: 65,
            column: 60
          },
          end: {
            line: 76,
            column: 7
          }
        },
        line: 65
      },
      "4": {
        name: "(anonymous_4)",
        decl: {
          start: {
            line: 86,
            column: 37
          },
          end: {
            line: 86,
            column: 38
          }
        },
        loc: {
          start: {
            line: 86,
            column: 51
          },
          end: {
            line: 88,
            column: 5
          }
        },
        line: 86
      },
      "5": {
        name: "(anonymous_5)",
        decl: {
          start: {
            line: 95,
            column: 35
          },
          end: {
            line: 95,
            column: 36
          }
        },
        loc: {
          start: {
            line: 95,
            column: 54
          },
          end: {
            line: 99,
            column: 3
          }
        },
        line: 95
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 66,
            column: 8
          },
          end: {
            line: 69,
            column: 9
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 66,
            column: 8
          },
          end: {
            line: 69,
            column: 9
          }
        }, {
          start: {
            line: 66,
            column: 8
          },
          end: {
            line: 69,
            column: 9
          }
        }],
        line: 66
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0,
      "20": 0,
      "21": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0
    },
    b: {
      "0": [0, 0]
    },
    _coverageSchema: "43e27e138ebf9cfc5966b082cf9a028302ed4184",
    hash: "a2ae6b4f1719cd047dc8ece164f69fb3b6500e69"
  };
  var coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  return coverage[path] = coverageData;
}();

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _user_controller = _interopRequireDefault(require("../controllers/user_controller"));

var _multer = _interopRequireDefault(require("multer"));

var _dotenv = _interopRequireDefault(require("dotenv"));

var aws = (cov_1gh6s2th7z.s[0]++, require('aws-sdk'));
cov_1gh6s2th7z.s[1]++;

_dotenv["default"].config(); // const aws_upload = require('./services/aws_uploads').upload;
//const singleUpload = aws_upload.single('image');


var uploadFile = (cov_1gh6s2th7z.s[2]++, require('./services/aws_uploads'));
/*
 * Configure the AWS region of the target bucket.
 * Remember to change this to the relevant region.
 */

cov_1gh6s2th7z.s[3]++;
aws.config.update({
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
  region: 'us-east-1'
}); //aws.config.region = 'eu-west-1';

/*
 * Load the S3 information from the environment variables.
 */

var S3_BUCKET = (cov_1gh6s2th7z.s[4]++, 'commute-bucket'); //process.env.S3_BUCKET;

var ApiUploads =
/*#__PURE__*/
function () {
  function ApiUploads(router) {
    (0, _classCallCheck2["default"])(this, ApiUploads);
    cov_1gh6s2th7z.f[0]++;
    cov_1gh6s2th7z.s[5]++;
    this.router = router;
  }

  (0, _createClass2["default"])(ApiUploads, [{
    key: "attachRoutes",
    value: function attachRoutes() {
      cov_1gh6s2th7z.f[1]++;
      cov_1gh6s2th7z.s[6]++;
      // this.router.post('/image/uploads', UserController.handleImageUpload);
      // this.router.post('/video/uploads', UserController.handleVideoUpload);
      //this.router.post('/image/profile/avater', upload.single('image-upload'), function (req, res, next) {
      //console.log("testing..")
      // The network path after file upload is spliced.
      // });

      /*
       * Respond to GET requests to /sign-s3.
       * Upon request, return JSON containing the temporarily-signed S3 request and
       * the anticipated URL of the image.
       */
      this.router.get('/sign-s3', function (req, res) {
        cov_1gh6s2th7z.f[2]++;
        var s3 = (cov_1gh6s2th7z.s[7]++, new aws.S3());
        var fileName = (cov_1gh6s2th7z.s[8]++, req.query['file-name']);
        var fileType = (cov_1gh6s2th7z.s[9]++, req.query['file-type']);
        var s3Params = (cov_1gh6s2th7z.s[10]++, {
          Bucket: S3_BUCKET,
          Key: fileName,
          //Expires: 60,
          ContentType: fileType //ACL: 'public-read'

        });
        cov_1gh6s2th7z.s[11]++;
        s3.getSignedUrl('putObject', s3Params, function (err, data) {
          cov_1gh6s2th7z.f[3]++;
          cov_1gh6s2th7z.s[12]++;

          if (err) {
            cov_1gh6s2th7z.b[0][0]++;
            cov_1gh6s2th7z.s[13]++;
            console.log(err);
            cov_1gh6s2th7z.s[14]++;
            return res.end();
          } else {
            cov_1gh6s2th7z.b[0][1]++;
          }

          var returnData = (cov_1gh6s2th7z.s[15]++, {
            signedRequest: data,
            url: "https://".concat(S3_BUCKET, ".s3.amazonaws.com/").concat(fileName)
          });
          cov_1gh6s2th7z.s[16]++;
          res.write(JSON.stringify(returnData));
          cov_1gh6s2th7z.s[17]++;
          res.end();
        });
      });
      /*
       * Respond to POST requests to /submit_form.
       * This function needs to be completed to handle the information in
       * a way that suits your application.
       */

      cov_1gh6s2th7z.s[18]++;
      this.router.put('/save-details', function (req, res) {// TODO: Read POSTed form data and do something useful

        cov_1gh6s2th7z.f[4]++;
      });
      cov_1gh6s2th7z.s[19]++;
      this.router.post('/image-upload', function (req, res) {
        cov_1gh6s2th7z.f[5]++;
        cov_1gh6s2th7z.s[20]++;
        console.log(req.body.files);
        cov_1gh6s2th7z.s[21]++;
        uploadFile(req.body.files);
      });
    }
  }]);
  return ApiUploads;
}();

var _default = ApiUploads;
exports["default"] = _default;
//# sourceMappingURL=api_uploads.js.map